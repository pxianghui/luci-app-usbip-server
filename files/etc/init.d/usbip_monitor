#!/bin/sh /etc/rc.common
# USBIP Monitor Service (procd enhanced)

START=99
STOP=10

USE_PROCD=1
NAME=usbip_monitor
DAEMON=/usr/bin/usbip_monitor.sh
PIDFILE=/var/run/usbip_monitor.pid

start_service() {
    # 禁用原始 usbipd 服务，避免冲突
    if [ -f /etc/init.d/usbipd ]; then
        /etc/init.d/usbipd disable 2>/dev/null
        /etc/init.d/usbipd stop 2>/dev/null
    fi

    procd_open_instance
    procd_set_param command "$DAEMON"
    procd_set_param respawn
    procd_set_param respawn_retry 5
    procd_set_param stdout 1
    procd_set_param stderr 1
    procd_set_param pidfile "$PIDFILE"
    procd_close_instance
}

stop_service() {
    # procd 会自动管理进程，这里只需关闭实例
    procd_kill "$NAME"
}

restart() {
    stop
    start
}

service_triggers() {
    # 当 /etc/config/usbip_server 发生变化时自动 reload
    procd_add_reload_trigger usbip_server
}
